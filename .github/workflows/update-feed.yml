name: Update and Publish Inderes RSS feeds (titles only)
on:
  schedule:
    - cron: "0 */1 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ðŸŸ¦ HAE SUOMENKIELINEN DATA
      - name: Fetch Inderes data (FI)
        run: |
          curl -s "https://ir-api.inderes.com/api/v1/publications?languages=fi&startDate=$(date -I -d '-7 days')" \
            -H "accept: application/json" \
            -H "x-api-key: ${{ secrets.INDERES_API_KEY }}" \
            -o data-fi.json

      # ðŸŸ© HAE ENGLANNINKIELINEN DATA
      - name: Fetch Inderes data (EN)
        run: |
          curl -s "https://ir-api.inderes.com/api/v1/publications?languages=en&startDate=$(date -I -d '-7 days')" \
            -H "accept: application/json" \
            -H "x-api-key: ${{ secrets.INDERES_API_KEY }}" \
            -o data-en.json

      # ðŸ“¦ RAKENNA FEEDIT (ilman sisÃ¤ltÃ¶Ã¤)
      - name: Build minimal RSS feeds
        run: |
          mkdir -p public

          # --- Finnish feed ---
          echo '<?xml version="1.0" encoding="UTF-8"?>' > public/feed-fi.xml
          echo '<rss version="2.0"><channel>' >> public/feed-fi.xml
          echo '<title>Inderes Publications (FI)</title>' >> public/feed-fi.xml
          echo '<link>https://ir.inderes.fi</link>' >> public/feed-fi.xml
          echo '<description>Inderes-julkaisut suomeksi â€“ otsikot ja linkit</description>' >> public/feed-fi.xml
          jq -r '.publications[] |
            "<item>
              <title>\(.title | gsub("&"; "&amp;"))</title>
              <link>https://www.inderes.fi/releases/\(.id)</link>
              <guid>\(.id)</guid>
              <pubDate>\(.createdAt)</pubDate>
            </item>"' data-fi.json >> public/feed-fi.xml
          echo '</channel></rss>' >> public/feed-fi.xml

          # --- English feed ---
          echo '<?xml version="1.0" encoding="UTF-8"?>' > public/feed-en.xml
          echo '<rss version="2.0"><channel>' >> public/feed-en.xml
          echo '<title>Inderes Publications (EN)</title>' >> public/feed-en.xml
          echo '<link>https://ir.inderes.fi</link>' >> public/feed-en.xml
          echo '<description>Inderes publications in English â€“ titles and links only</description>' >> public/feed-en.xml
          jq -r '.publications[] |
            "<item>
              <title>\(.title | gsub("&"; "&amp;"))</title>
              <link>https://www.inderes.fi/releases/\(.id)</link>
              <guid>\(.id)</guid>
              <pubDate>\(.createdAt)</pubDate>
            </item>"' data-en.json >> public/feed-en.xml
          echo '</channel></rss>' >> public/feed-en.xml

      - name: Validate XML
        run: |
          sudo apt-get update && sudo apt-get install -y libxml2-utils
          xmllint --noout public/feed-fi.xml
          xmllint --noout public/feed-en.xml

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
