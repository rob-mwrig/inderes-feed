name: Update and Publish Inderes RSS feeds (titles only)

on:
  schedule:
    - cron: "0 */1 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ðŸŸ¦ Hae Suomenkielinen data
      - name: Fetch Inderes data (FI)
        run: |
          curl -s "https://ir-api.inderes.com/api/v1/publications?languages=fi&startDate=$(date -I -d '-7 days')" \
            -H "accept: application/json" \
            -H "x-api-key: ${{ secrets.INDERES_API_KEY }}" \
            -o data-fi.json

      # ðŸŸ© Hae englanninkielinen data
      - name: Fetch Inderes data (EN)
        run: |
          curl -s "https://ir-api.inderes.com/api/v1/publications?languages=en&startDate=$(date -I -d '-7 days')" \
            -H "accept: application/json" \
            -H "x-api-key: ${{ secrets.INDERES_API_KEY }}" \
            -o data-en.json

      # ðŸ“¦ Rakenna feedit + sivut
      - name: Build feeds and viewer pages
        run: |
          mkdir -p public

          # --- Finnish feed ---
          echo '<?xml version="1.0" encoding="UTF-8"?>' > public/feed-fi.xml
          echo '<rss version="2.0"><channel>' >> public/feed-fi.xml
          echo '<title>Inderes Publications (FI)</title>' >> public/feed-fi.xml
          echo '<link>https://ir.inderes.fi</link>' >> public/feed-fi.xml
          echo '<description>Inderes-julkaisut suomeksi â€“ otsikot ja linkit</description>' >> public/feed-fi.xml
          jq -r '.publications[] |
            "<item>
              <title>\(.title | gsub("&"; "&amp;"))</title>
              <link>https://www.inderes.fi/releases/\(.id)</link>
              <guid>\(.id)</guid>
              <pubDate>\(.createdAt)</pubDate>
            </item>"' data-fi.json >> public/feed-fi.xml
          echo '</channel></rss>' >> public/feed-fi.xml

          # --- English feed ---
          echo '<?xml version="1.0" encoding="UTF-8"?>' > public/feed-en.xml
          echo '<rss version="2.0"><channel>' >> public/feed-en.xml
          echo '<title>Inderes Publications (EN)</title>' >> public/feed-en.xml
          echo '<link>https://ir.inderes.fi</link>' >> public/feed-en.xml
          echo '<description>Inderes publications in English â€“ titles and links only</description>' >> public/feed-en.xml
          jq -r '.publications[] |
            "<item>
              <title>\(.title | gsub("&"; "&amp;"))</title>
              <link>https://www.inderes.fi/releases/\(.id)</link>
              <guid>\(.id)</guid>
              <pubDate>\(.createdAt)</pubDate>
            </item>"' data-en.json >> public/feed-en.xml
          echo '</channel></rss>' >> public/feed-en.xml

          # --- HTML viewers ---
          cat > public/en.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <title>Robit â€“ News</title>
            <style>
              body { font-family: "Segoe UI", sans-serif; margin: 1.5em; }
              h2 { color: #004b8d; border-bottom: 2px solid #004b8d; padding-bottom: 0.3em; }
              .feed-item { margin-bottom: 1em; border-bottom: 1px solid #ddd; padding-bottom: .8em; }
              .feed-item a { color: #004b8d; font-weight: 600; text-decoration: none; }
              .feed-item a:hover { text-decoration: underline; }
              .pubDate { color: gray; font-size: 0.85em; }
            </style>
          </head>
          <body>
            <h2>Robit â€“ News</h2>
            <div id="feed">Loading feedâ€¦</div>
            <script>
              const feedUrl = 'https://robitgroup.github.io/inderes-feed/feed-en.xml';
              const apiUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(feedUrl)}`;
              fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                  const parser = new DOMParser();
                  const xml = parser.parseFromString(data.contents, "text/xml");
                  const items = xml.querySelectorAll("item");
                  const container = document.getElementById("feed");
                  container.innerHTML = "";
                  if (items.length === 0) { container.textContent = "No news available."; return; }
                  items.forEach(item => {
                    const title = item.querySelector("title")?.textContent || "";
                    const link = item.querySelector("link")?.textContent || "#";
                    const pubDate = new Date(item.querySelector("pubDate")?.textContent || "").toLocaleDateString("en-GB");
                    const div = document.createElement("div");
                    div.className = "feed-item";
                    div.innerHTML = \`<a href="\${link}" target="_blank">\${title}</a><div class="pubDate">\${pubDate}</div>\`;
                    container.appendChild(div);
                  });
                })
                .catch(() => document.getElementById("feed").textContent = "Feed unavailable.");
            </script>
          </body>
          </html>
          EOF

          cat > public/fi.html <<'EOF'
          <!DOCTYPE html>
          <html lang="fi">
          <head>
            <meta charset="UTF-8">
            <title>Robit â€“ Uutiset</title>
            <style>
              body { font-family: "Segoe UI", sans-serif; margin: 1.5em; }
              h2 { color: #004b8d; border-bottom: 2px solid #004b8d; padding-bottom: 0.3em; }
              .feed-item { margin-bottom: 1em; border-bottom: 1px solid #ddd; padding-bottom: .8em; }
              .feed-item a { color: #004b8d; font-weight: 600; text-decoration: none; }
              .feed-item a:hover { text-decoration: underline; }
              .pubDate { color: gray; font-size: 0.85em; }
            </style>
          </head>
          <body>
            <h2>Robit â€“ Uutiset</h2>
            <div id="feed">Ladataan syÃ¶tettÃ¤â€¦</div>
            <script>
              const feedUrl = 'https://robitgroup.github.io/inderes-feed/feed-fi.xml';
              const apiUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(feedUrl)}`;
              fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                  const parser = new DOMParser();
                  const xml = parser.parseFromString(data.contents, "text/xml");
                  const items = xml.querySelectorAll("item");
                  const container = document.getElementById("feed");
                  container.innerHTML = "";
                  if (items.length === 0) { container.textContent = "Ei uutisia."; return; }
                  items.forEach(item => {
                    const title = item.querySelector("title")?.textContent || "";
                    const link = item.querySelector("link")?.textContent || "#";
                    const pubDate = new Date(item.querySelector("pubDate")?.textContent || "").toLocaleDateString("fi-FI");
                    const div = document.createElement("div");
                    div.className = "feed-item";
                    div.innerHTML = \`<a href="\${link}" target="_blank">\${title}</a><div class="pubDate">\${pubDate}</div>\`;
                    container.appendChild(div);
                  });
                })
                .catch(() => document.getElementById("feed").textContent = "SyÃ¶tettÃ¤ ei voitu ladata.");
            </script>
          </body>
          </html>
          EOF

      - name: Validate XML
        run: |
          sudo apt-get update && sudo apt-get install -y libxml2-utils
          xmllint --noout public/feed-fi.xml
          xmllint --noout public/feed-en.xml

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
